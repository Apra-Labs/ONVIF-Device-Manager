name: ODM

on:
  push:
    branches: [ "ak/automate-build" ]
  pull_request:
    branches: [ "ak/automate-build" ]

jobs:

  build:

    runs-on: windows-2022

    env:
      Solution_Name: odm.sln                         # Replace with your solution name, i.e. MyWpfApp.sln.
      VS_Install_Dir: 'C:\Program Files\Microsoft Visual Studio\2022\Enterprise\Commmon7\IDE' # Replace with your Visual Studio installation directory.

    steps:
    - name: Checkout
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: build application
      run: |
       '${{env.VS_Install_Dir}}\devenv' ${{ env.Solution_Name }} /Build "Release|x64" /Project odm.ui.app
      shell: cmd
    
    - name: collect artifacts
      run: |
       package.bat
      shell: cmd
    
    - name: upload artifacts 
      uses: actions/upload-artifact@v4
      with:
        name: odm-build-zip
        path: build/

    - name: DisableOutOfProcBuild
      working-directory: '${{env.VS_Install_Dir}}\CommonExtensions\Microsoft\VSI\DisableOutOfProcBuild'
      run: |
       'DisableOutOfProcBuild' 

    - name: build installer
      run: |
        '${{env.VS_Install_Dir}}\devenv' ${{ env.Solution_Name }} /Build "Release|x64" /Project odm.setup
      shell: cmd

    - name: upload installer 
      uses: actions/upload-artifact@v4
      with:
          name: odm-installer
          path: odm.setup/Release/odm.setup.msi
  